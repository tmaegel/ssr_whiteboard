{% extends 'base.html' %}

{% block topbar %}
<div class="bar w3-top w3-dark-grey padding-8-y">
  <div class="w3-bar">
    {% include 'general/title.html' %}
    <a {{ "onclick=document.getElementById('deleteWorkoutDialog').style.display='block';" if workout.userId != 1 }} href="#"
      class="w3-bar-item w3-button w3-text-white w3-hover-dark-gray w3-hover-text-blue w3-right
      {{ 'w3-disabled' if workout.userId == 1 }}"><i class="icon fa fa-trash"></i>
    </a>
  </div>
</div>
{% endblock %}

{% block content %}
{% include 'workout/edit_dialog.html' %}
{% include 'workout/delete_dialog.html' %}
{% include 'score/add_dialog.html' %}
{% include 'score/edit_dialog.html' %}
{% include 'general/overlay_button_add.html' %}
{% include 'general/overlay_button_edit.html' %}

<div class="w3-margin">
  <h2>{{ workout.name }}</h2>
    <p>
      {% for item in workout.description.splitlines() %}
        {{ item }}<br />
      {% endfor %}
    </p>
    <div class="w3-margin-top">
      {% for tag in workout.tags %}
        <span class="w3-badge w3-blue w3-round-small padding-4-y padding-8-x">{{ tag.tag }}</span>
      {% endfor %}
    </div>
</div>
{% if scores | length > 1 %}
  <canvas id="chart"></canvas>
{% endif %}
{% if scores | length > 0 %}
  <table class="w3-table w3-bordered w3-hoverable">
    {% for score in scores | reverse %}
    <tr id="{{ score.id }}" class="w3-hover-light-gray pointer" onclick="openEditScoreDialog(this)">
      <td class="scoreRx w3-padding-16">
        {% if score.rx == 1 %}
        <span class="w3-badge w3-small w3-light-gray w3-round-small padding-4-y padding-8-x">Rx</span>
        {% endif %}
      </td>
      <td class="scoreDatetime w3-padding-16">{{ get_format_timestamp(score.datetime) }}</td>
      <td class="scoreValue w3-padding-16">{{ score.score }}</td>
      <td class="scoreNote w3-padding-16">{{ score.note }}</td>
    </tr>
    {% endfor %}
  </table>
{% endif %}
{% endblock %}

{% block script %}
<script>
function openEditScoreDialog(element) {
  let scoreId, scoreValue, scoreDatetime, scoreNote, scoreRx;
  scoreId = element.id;
  scoreValue = element.getElementsByClassName('scoreValue')[0].innerText;
  scoreDatetime = element.getElementsByClassName('scoreDatetime')[0].innerText;
  scoreNote = element.getElementsByClassName('scoreNote')[0].innerText;
  scoreRx = element.getElementsByClassName('scoreRx')[0].innerText;
  document.getElementById('editScoreValue').value = scoreValue;
  document.getElementById('editScoreDatetime').value = scoreDatetime;
  document.getElementById('editScoreNote').value = scoreNote;
  document.getElementById('editScoreValue').value = scoreValue;
  if(scoreRx == "Rx") {
    document.getElementById('editScoreRx').checked = true;
  } else {
    document.getElementById('editScoreRx').checked = false;
  }
  document.getElementById('editScoreForm').action = '{{ url_for(request.endpoint, workout_id=workout.id) }}/score/' + scoreId + '/update';
  document.getElementById('deleteScoreBtn').formAction = '{{ url_for(request.endpoint, workout_id=workout.id) }}/score/' + scoreId + '/delete';
  document.getElementById('editScoreDialog').style.display='block'
}

var ctx = document.getElementById('chart').getContext('2d');
var chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [
          {% for score in scores %}
            "{{ get_format_timestamp(score.datetime) }}",
          {% endfor %}
        ],
        datasets: [{
            data: [
              {% for score in scores %}
                "{{ timestamp_to_sec(score.score) }}",
              {% endfor %}
            ]
        }]
    },
    options: {
      layout: {
        padding: {
          left: 0,
          right: 0,
          top: 10,
          bottom: 0,
        },
      },
      tooltips: {
        xPadding: 10,
        yPadding: 10,
        cornerRadius: 5,
        backgroundColor: 'rgba(33, 150, 243, 0.20)',
        titleFontColor: '#343a40',
        bodyFontColor: '#343a40',
        footerFontColor: '#343a40',
        borderWidth: 0,
        borderColor: 'rgba(33, 150, 243, 0.5)',
        displayColors: false,
        caretPadding: 10,
        caretSize: 5,
      },
      elements: {
        point: {
          radius: 5,
          hoverRadius: 6,
          hitRadius: 1,
          hoverBorderWidth: 2,
          borderColor: 'rgba(12, 58, 95, 0.1)',
          backgroundColor: 'rgba(12, 58, 95, 0.1)',
        },
        line: {
          borderWidth: 3,
          borderColor: 'rgba(33, 150, 243, 1.0)',
          backgroundColor: 'rgba(33, 150, 243, 0.10)',
        },
      },
      scales: {
        yAxes: [{
          display: true,
          position: 'right',
          ticks: {
            display: false,
            mirror: true,
            padding: -10,
            maxTicksLimit: 5,
            labelOffset: 0,
          },
          gridLines: {
            display: true,
            color: '#f1f1f1',
            zeroLineColor: '#ddd',
            tickMarkLength: 0,
          },
        }],
        xAxes: [{
          display: true,
          ticks: {
            display: false,
          },
          gridLines: {
            display: false,
            color: '#f1f1f1',
            zeroLineColor: '#ddd',
            tickMarkLength: 1,
          },
        }],
      },
      legend: {
        display: false,
      },
      showLine: true,
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 3
    },
});
</script>
{% endblock %}
